{% extends "base.html" %}
{% load static %}
{% block title %}Detección de Eventos Especiales{% endblock %}

{% block styles %}
    <style>
        #shift-container > .row {
            margin-bottom: 5px;
        }
    </style>
{% endblock %}

{% block content %}
    <h3 class="mb-3">Detección de Eventos Especiales</h3>
    <form method="post" enctype="multipart/form-data">
        {% csrf_token %}
        <div class="form-group row">
            <label for="name-id" class="col-sm-2 col-form-label">Nombre</label>
            <div class="col-sm-5">
                <input name="name" id="name-id" type="text" class="form-control" required>
            </div>
        </div>
        <div class="row mb-2">
            <div class="col-sm-7">
                <div class="custom-file">
                    <input type="file" name="events" class="custom-file-input" id="events-input" required>
                    <label class="custom-file-label" for="events-input">Cargar archivo de eventos</label>
                </div>
            </div>
            <div class="col-sm-5"><span id="events-filename" class="badge badge-secondary" style="display: none"></span></div>
        </div>
        <hr>
        <div id="chart-div" style="display: none">
            <h5>Graficos exploratorios</h5>
            <div class="form-row">
                <div class="col">
                    <label for="driver-id" class="mr-2">Driver</label>
                    <select class="form-control inline-select mb-2 mr-sm-2" id="driver-id" name="driver">
                    </select>
                </div>
            </div>
            <canvas id="events-chart" style="width: 100%"></canvas>
            <hr>
            <div class="form-group row">
                <label for="range_id" class="col-sm-2 col-form-label">Rango de analisis</label>
                <div class="col-sm-5">
                    <input name="range" id="range_id" type="text" class="form-control" required>
                    <input type="hidden" name="sheet_start_date" />
                    <input type="hidden" name="sheet_end_date" />
                </div>
            </div>
            <table id="parameters-table" class="table table-striped table-bordered" style="width:100%">
                <thead>
                <tr>
                    <th>Variable</th>
                    <th>Mínimo</th>
                    <th>Maximo</th>
                    <th>Incremento</th>
                </tr>
                </thead>
                <tbody>
                <tr>
                    <td>Dias</td>
                    <td><label for="days_min_id" class="sr-only"></label><input class="form-control" type="number" name="days_min" id="days_min_id" step="1" required></td>
                    <td><label for="days_max_id" class="sr-only"></label><input class="form-control" type="number" name="days_max" id="days_max_id" step="1" required></td>
                    <td><label for="days_step_id" class="sr-only"></label><input class="form-control" type="number" name="days_step" id="days_step_id" step="1" required></td>
                </tr>
                <tr>
                    <td>Sensitividad</td>
                    <td><label for="sensitivity_min_id" class="sr-only"></label><input class="form-control" type="number" name="sensitivity_min" id="sensitivity_min_id" step="any" required></td>
                    <td><label for="sensitivity_max_id" class="sr-only"></label><input class="form-control" type="number" name="sensitivity_max" id="sensitivity_max_id" step="any" required></td>
                    <td><label for="sensitivity_step_id" class="sr-only"></label><input class="form-control" type="number" name="sensitivity_step" id="sensitivity_step_id" step="any" required></td>
                </tr>
                </tbody>
            </table>
        </div>

        <button id="submit-btn" type="submit" class="btn btn-success mb-2">Detectar Eventos Especiales</button>
    </form>

{% endblock %}

{% block scripts %}
    <script>
        let selectedDriver, driversData, lineChart = null;

        $(document).ready(function() {
            let demandInputSelector = $('#events-input');
            let driverSelector = $('#driver-id');

            driverSelector.change(function () {
                selectedDriver = driverSelector.val();
                drawChart();
            });

            demandInputSelector.change(function (event) {
                $('#events-filename').html(''+demandInputSelector.val().split(/(\\|\/)/g).pop()).show();

                let files = event.target.files, f = files[0];
                let reader = new FileReader();
                reader.onload = function(event) {
                    $('#chart-div').show();
                    let data = new Uint8Array(event.target.result);
                    let workbook = XLSX.read(data, {type: 'array', cellDates: true});

                    let rows = XLSX.utils.sheet_to_row_object_array(workbook.Sheets[workbook.SheetNames[0]]);
                    let startDate = rows[0]['FECHA'];
                    let endDate = rows[rows.length - 1]['FECHA'];
                    let sheetStartDate = moment({
                        day: startDate.getUTCDate(),
                        month: startDate.getUTCMonth(),
                        year: startDate.getUTCFullYear()
                    });
                    let sheetEndDate = moment({
                        day: endDate.getUTCDate(),
                        month: endDate.getUTCMonth(),
                        year: endDate.getUTCFullYear()
                    });

                    $('#range_id').daterangepicker({
                        startDate: sheetStartDate,
                        endDate: sheetEndDate,
                        minDate: sheetStartDate,
                        maxDate: sheetEndDate,
                        locale: dataRangePickerLocale
                    });

                    $('input[name="sheet_start_date"]').val(sheetStartDate.format('DD/MM/YYYY'));
                    $('input[name="sheet_end_date"]').val(sheetEndDate.format('DD/MM/YYYY'));


                    let drivers = [];//Object.keys(rows[0]);
                    //nonDriverIndex = drivers.indexOf('FECHA');
                    //if (nonDriverIndex > -1) {
                    //    drivers.splice(nonDriverIndex, 1);
                    //}
                    driversData = {}
                    let currentDriver = '!!!!!!';
                    let driverObj, weekMonday, weekSummary = null;

                    rows.forEach(function (row, j) {
                        if (row['DRIVER'] !== currentDriver) {
                            currentDriver = row['DRIVER'];
                            drivers.push(currentDriver);
                            driverSelector.append('<option>'+currentDriver+'</option');
                            driverObj = {
                                '0': [],
                                '1': [],
                                '2': [],
                                '3': [],
                                '4': [],
                                '5': [],
                                '6': [],
                                'summary': []
                            }
                            driversData[currentDriver] = driverObj;
                            weekMonday = sheetStartDate.startOf('isoweek');
                            weekSummary = {
                                t: weekMonday,
                                y: 0
                            }
                        }
                        let iterDate = row['FECHA'];
                        let momentDate = moment({
                            day: iterDate.getUTCDate(),
                            month: iterDate.getUTCMonth(),
                            year: iterDate.getUTCFullYear()
                        });
                        if (j < 50) {
                            console.log(iterDate, momentDate);
                        }

                        let weekday = momentDate.weekday()
                        driverObj[weekday].push({
                            t: momentDate,
                            y: row['VALOR']
                        });
                        let iterWeekMonday = momentDate.clone().startOf('isoweek');
                        if (weekMonday.isSame(iterWeekMonday)) {
                            weekSummary.y = row['VALOR'] + weekSummary.y;
                        } else {
                            driverObj['summary'].push(weekSummary);
                            weekMonday = iterWeekMonday;
                            weekSummary = {
                                t: weekMonday,
                                y: row['VALOR']
                            }
                        }
                    });

                    selectedDriver = driverSelector.val();
                    drawChart();
                };
                reader.readAsArrayBuffer(f);
            });
        });


        function drawChart() {
            let chartColors = ['rgba(244, 67, 54, 0.3)', 'rgba(33, 150, 243, 0.3)', 'rgba(76, 175, 80, 0.3)',
                'rgba(255, 235, 59, 0.8)', 'rgba(156, 39, 176, 0.3)', 'rgba(255, 87, 34, 0.3)',
                'rgba(0, 150, 136, 0.3)', 'rgba(121, 85, 72, 0.3)'];//http://materialuicolors.co/
            let chartOptions = {
                scales: {
                    xAxes: [{
                        type: 'time',
                        distribution: 'linear',
                        time: {
                            unit: 'day',
                            tooltipFormat:'DD/MM/YYYY'
                        }
                    }],
                    yAxes: [{
                        scaleLabel: {
                            display:     true,
                            labelString: 'Cantidad'
                        }
                    }]
                }
            };
            let canvasSelector = $('#events-chart');
            if (lineChart !== null) {
                lineChart.destroy();
            }
            lineChart = new Chart(canvasSelector, {
                type: 'line',
                data: {
                    datasets: [{
                        data: driversData[selectedDriver][1],
                        label: "Lunes",
                        fill: false,
                        cubicInterpolationMode: 'monotone',
                        lineTension: 0,
                        hidden: false,
                        backgroundColor: chartColors[0],
                        borderColor: chartColors[0],
                    },
                    {
                        data: driversData[selectedDriver][2],
                        label: "Martes",
                        fill: false,
                        cubicInterpolationMode: 'monotone',
                        lineTension: 0,
                        hidden: true,
                        backgroundColor: chartColors[1],
                        borderColor: chartColors[1],
                    },
                    {
                        data: driversData[selectedDriver][3],
                        label: "Miercoles",
                        fill: false,
                        cubicInterpolationMode: 'monotone',
                        lineTension: 0,
                        hidden: true,
                        backgroundColor: chartColors[2],
                        borderColor: chartColors[2],
                    },
                    {
                        data: driversData[selectedDriver][4],
                        label: "Jueves",
                        fill: false,
                        cubicInterpolationMode: 'monotone',
                        lineTension: 0,
                        hidden: true,
                        backgroundColor: chartColors[3],
                        borderColor: chartColors[3],
                    },
                    {
                        data: driversData[selectedDriver][5],
                        label: "Viernes",
                        fill: false,
                        cubicInterpolationMode: 'monotone',
                        lineTension: 0,
                        hidden: true,
                        backgroundColor: chartColors[4],
                        borderColor: chartColors[4],
                    },
                    {
                        data: driversData[selectedDriver][6],
                        label: "Sabado",
                        fill: false,
                        cubicInterpolationMode: 'monotone',
                        lineTension: 0,
                        hidden: true,
                        backgroundColor: chartColors[5],
                        borderColor: chartColors[5],
                    },
                    {
                        data: driversData[selectedDriver][0],
                        label: "Domingo",
                        fill: false,
                        cubicInterpolationMode: 'monotone',
                        lineTension: 0,
                        hidden: true,
                        backgroundColor: chartColors[6],
                        borderColor: chartColors[6],
                    },
                    {
                        data: driversData[selectedDriver]['summary'],
                        label: "Semanal",
                        fill: false,
                        cubicInterpolationMode: 'monotone',
                        lineTension: 0,
                        hidden: true,
                        backgroundColor: chartColors[7],
                        borderColor: chartColors[7],
                    }]
                },
                options: chartOptions
            });
        }
    </script>
{% endblock %}